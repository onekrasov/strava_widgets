"use strict";(()=>{var __require=(x=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(x,{get:(a,b)=>(typeof require!="undefined"?require:a)[b]}):x)(function(x){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+x+'" is not supported')});function calculateCyclingTSS(movingTime,np,ftp){if(ftp<=0)return 0;let intensityFactor=np/ftp;return movingTime*np*intensityFactor/(ftp*3600)*100}function calculateStats(activities,userFtp,userWeight,zones){var _a,_b,_c,_d,_e;let hrZones=((_a=zones.heart_rate)==null?void 0:_a.zones)||[],ftpZones=((_c=(_b=zones.power)==null?void 0:_b.zones)==null?void 0:_c.map(z=>z.max))||[],ZLOW_END=ftpZones[1]||userFtp*.75,ZMID_END=ftpZones[3]||userFtp*.95,HR_LOW_END=((_d=hrZones[1])==null?void 0:_d.max)||getMaxHeartRate(zones)*.8,HR_MID_END=((_e=hrZones[3])==null?void 0:_e.max)||getMaxHeartRate(zones)*.9,totalTSS7d=0,sumTSS28d=0,totalWorkoutTime7d=0,lowIntensityTime=0,mediumIntensityTime=0,highIntensityTime=0,totalIntensityTime=0,totalIF=0,ifCount=0,totalEF=0,efCount=0,now=Math.floor(Date.now()/1e3),sevenDaysAgo=now-10080*60,twentyEightDaysAgo=now-672*60*60;if(!activities||activities.length===0)return{totalTSS:0,totalWorkoutTime:0,acwr:0,avgIF:0,lowIntensityPercent:0,mediumIntensityPercent:0,highIntensityPercent:0,avgEF:0};activities.forEach(activity=>{var _a2,_b2,_c2,_d2;let activityTime=new Date(activity.start_date).getTime()/1e3,movingTime=activity.moving_time||0,isCycling=["Ride","VirtualRide","EBikeRide"].includes(activity.sport_type),np=activity.weighted_average_watts||activity.average_watts||0,activityTSS=0;if(isCycling&&np>0&&userFtp>0){activityTSS=calculateCyclingTSS(movingTime,np,userFtp);let intensityFactor=np/userFtp;activityTime>=sevenDaysAgo&&(totalIF+=intensityFactor,ifCount++)}else activity.suffer_score&&(activityTSS=activity.suffer_score);if(activityTime>=twentyEightDaysAgo&&(sumTSS28d+=activityTSS,activityTime>=sevenDaysAgo&&(totalTSS7d+=activityTSS,totalWorkoutTime7d+=movingTime)),activityTime>=sevenDaysAgo){let hasPowerStream=((_a2=activity.watts)==null?void 0:_a2.data)&&((_b2=activity.time)==null?void 0:_b2.data),hasHRStream=((_c2=activity.heartrate)==null?void 0:_c2.data)&&((_d2=activity.time)==null?void 0:_d2.data);if(isCycling&&hasPowerStream){let powerData=activity.watts.data,timeData=activity.time.data;for(let i=0;i<powerData.length;i++){let duration=i===0?1:timeData[i]-timeData[i-1];if(duration>15||duration<=0)continue;let watts=powerData[i];totalIntensityTime+=duration,watts<=ZLOW_END?lowIntensityTime+=duration:watts<=ZMID_END?mediumIntensityTime+=duration:highIntensityTime+=duration}}else if(hasHRStream){let hrData=activity.heartrate.data,timeData=activity.time.data;for(let i=0;i<hrData.length;i++){let duration=i===0?1:timeData[i]-timeData[i-1];if(duration>15||duration<=0)continue;let hrVal=hrData[i];totalIntensityTime+=duration,hrVal<=HR_LOW_END?lowIntensityTime+=duration:hrVal<=HR_MID_END?mediumIntensityTime+=duration:highIntensityTime+=duration}}}isCycling&&activity.average_heartrate&&np>0&&np/userFtp<.85&&(totalEF+=np/activity.average_heartrate,efCount++)});let acuteLoad=totalTSS7d,chronicLoad=sumTSS28d/4,acwr=chronicLoad>10?acuteLoad/chronicLoad:0;return{totalTSS:Math.round(totalTSS7d),totalWorkoutTime:totalWorkoutTime7d,acwr:parseFloat(acwr.toFixed(2)),avgIF:ifCount>0?parseFloat((totalIF/ifCount).toFixed(2)):0,lowIntensityPercent:totalIntensityTime>0?Math.round(lowIntensityTime/totalIntensityTime*100):0,mediumIntensityPercent:totalIntensityTime>0?Math.round(mediumIntensityTime/totalIntensityTime*100):0,highIntensityPercent:totalIntensityTime>0?Math.round(highIntensityTime/totalIntensityTime*100):0,avgEF:efCount>0?parseFloat((totalEF/efCount).toFixed(2)):0}}function getMaxHeartRate(zones){var _a;if((_a=zones.heart_rate)!=null&&_a.zones){let max=Math.max(...zones.heart_rate.zones.map(z=>z.max));if(max>0)return max}return 185}var Strava=class{constructor(clientId,clientSecret,refreshToken,isScriptable=!1){this.token="";this.isScriptable=!1;this.TOKEN_API="https://www.strava.com/oauth/token";this.STRAVA_API_BASE_URL="https://www.strava.com/api/v3";this.EXCLUDED_TYPES=["Walk","EBikeRide"];this.CACHE_FOLDER="./cache";if(this.clientId=clientId,this.clientSecret=clientSecret,this.refreshToken=refreshToken,this.isScriptable=isScriptable,!isScriptable&&typeof __require!="undefined")try{this.fs=__require("fs")}catch(e){}}async getToken(){return this.token||(this.token=await this.obtainStravaToken()),this.token}async obtainStravaToken(){try{let url=`${this.TOKEN_API}?client_id=${this.clientId}&client_secret=${this.clientSecret}&refresh_token=${this.refreshToken}&grant_type=refresh_token`;console.log("Fetching Strava token...");let data=await this.fetchAsync(url,"POST");return console.log("Token obtained successfully"),data.access_token}catch(e){throw console.error("Error obtaining Strava access token:",e),e}}async getAtheleteInfo(){try{let token=await this.getToken(),url=`${this.STRAVA_API_BASE_URL}/athlete?access_token=${token}`;return await this.fetchAsync(url,"GET")}catch(e){throw console.error("Error loading Strava athlete info:",e),e}}async getAthleteZones(){try{let token=await this.getToken(),url=`${this.STRAVA_API_BASE_URL}/athlete/zones?access_token=${token}`;return await this.fetchAsync(url,"GET")}catch(e){throw console.error("Error loading Strava athlete zones:",e),e}}async loadActivities(){try{let twentyEightDaysAgo=Math.floor(Date.now()/1e3)-2419200,token=await this.getToken(),url=`${this.STRAVA_API_BASE_URL}/athlete/activities?access_token=${token}&after=${twentyEightDaysAgo}&per_page=200`;console.log("Fetching activities...");let activities=await this.fetchAsync(url,"GET");console.log(`Loaded ${activities.length} activities`);let filteredActivities=activities.filter(activity=>!this.EXCLUDED_TYPES.includes(activity.sport_type));for(let activity of filteredActivities){let streams=this.loadCache(`activity_streams_${activity.id}`);if(!streams){try{streams=await this.getActivityStreams(activity.id,["watts","heartrate","velocity_smooth","distance","time"]),this.saveCache(`activity_streams_${activity.id}`,streams)}catch(e){console.error(`Error loading streams for activity ${activity.id}:`,e)}this.isScriptable?await new Promise(resolve=>{let timer=Timer.schedule(1e3,!1,resolve)}):await new Promise(resolve=>setTimeout(resolve,1e3))}activity.watts=streams.watts,activity.heartrate=streams.heartrate,activity.velocity_smooth=streams.velocity_smooth,activity.time=streams.time}return filteredActivities}catch(e){throw console.error("Error loading Strava activities:",e),e}}async getActivityStreams(activityId,keys){try{let token=await this.getToken(),url=`${this.STRAVA_API_BASE_URL}/activities/${activityId}/streams?access_token=${token}&keys=${keys.join(",")}&key_by_type=true`;return await this.fetchAsync(url,"GET")}catch(e){throw console.error(`Error loading Strava activity streams for activity ${activityId}:`,e),e}}async fetchAsync(url,method){if(this.isScriptable)try{let req=new Request(url);req.method=method,req.headers={"Content-Type":"application/json"},req.timeoutInterval=30;let data=await req.loadJSON();if(data&&data.errors)throw new Error(`Strava API error: ${JSON.stringify(data.errors)}`);return data}catch(e){throw console.error(`Scriptable Request failed for ${url}:`,e),e}else{let response=await fetch(url,{method,headers:{"Content-Type":"application/json"}});if(!response.ok)throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);return await response.json()}}saveCache(key,data){let jsonData=JSON.stringify(data);if(this.isScriptable){let fm=FileManager.local(),cachePath2=fm.joinPath(fm.documentsDirectory(),`${key}.json`);return fm.writeString(cachePath2,jsonData),!0}let cachePath=`${this.CACHE_FOLDER}/${key}.json`;return this.fs.existsSync(this.CACHE_FOLDER)||this.fs.mkdirSync(this.CACHE_FOLDER),this.fs.existsSync(cachePath)&&this.fs.unlinkSync(cachePath),this.fs.writeFileSync(cachePath,jsonData,"utf-8"),!0}loadCache(key){try{if(this.isScriptable){let fm=FileManager.local(),cachePath=fm.joinPath(fm.documentsDirectory(),`${key}.json`);if(!fm.fileExists(cachePath))return null;let jsonData2=fm.readString(cachePath);return JSON.parse(jsonData2)}let jsonData=this.fs.readFileSync(`${this.CACHE_FOLDER}/${key}.json`,"utf-8");return JSON.parse(jsonData)}catch(e){return null}}};async function createWidget(activities,ftp,weight,zones){let list=new ListWidget,stats=calculateStats(activities,ftp,weight,zones),bg1=new Color("#514e4eff"),bg2=new Color("#282727ff"),textColor=new Color("#ffffff"),labelColor=new Color("#aaaaaa"),separatorColor=new Color("#555555"),gradient=new LinearGradient;gradient.locations=[0,1],gradient.colors=[bg1,bg2],list.backgroundGradient=gradient;function addRow(label,value,valueColor=textColor,valueFontSize=16){let row=list.addStack();row.layoutHorizontally(),row.centerAlignContent();let labelText=row.addText(label);labelText.font=Font.regularSystemFont(11),labelText.textColor=labelColor,labelText.leftAlignText(),row.addSpacer();let valueText=row.addText(value);valueText.font=Font.boldSystemFont(valueFontSize),valueText.textColor=valueColor,valueText.rightAlignText()}function addSeparator(){list.addSpacer(2);let sep=list.addStack();sep.backgroundColor=separatorColor,sep.size=new Size(0,1),list.addSpacer(2)}if(addRow("TSS",stats.totalTSS.toString(),textColor,18),list.addSpacer(3),addRow("Time",formatTime(stats.totalWorkoutTime),textColor,18),addSeparator(),stats.acwr>0){let acwrColor=textColor;stats.acwr>=.8&&stats.acwr<=1.3?acwrColor=new Color("#00FF00"):stats.acwr>1.5?acwrColor=new Color("#FF4444"):acwrColor=new Color("#FFD700"),addRow("ACWR",stats.acwr.toFixed(2),acwrColor,14),list.addSpacer(3)}if(stats.avgIF>0&&(addRow("Intensity",stats.avgIF.toFixed(2),textColor,14),list.addSpacer(3)),stats.avgEF>0&&(addRow("Efficiency",stats.avgEF.toFixed(2),textColor,14),list.addSpacer(3)),stats.lowIntensityPercent>0||stats.highIntensityPercent>0){addSeparator();let distRow=list.addStack();distRow.layoutHorizontally();let distLabel=distRow.addText("Zone");distLabel.font=Font.regularSystemFont(11),distLabel.textColor=labelColor,distRow.addSpacer();let percentText=distRow.addText(`${stats.lowIntensityPercent.toFixed(0)}% / ${stats.mediumIntensityPercent.toFixed(0)}% / ${stats.highIntensityPercent.toFixed(0)}%`);percentText.font=Font.boldSystemFont(11),percentText.textColor=textColor,list.addSpacer(3);let barStack=list.addStack();barStack.layoutHorizontally(),barStack.size=new Size(0,10);let lowBar=barStack.addStack();lowBar.backgroundColor=new Color("#4CAF50"),lowBar.size=new Size(stats.lowIntensityPercent*1.4,10),lowBar.cornerRadius=5;let mediumBar=barStack.addStack();mediumBar.backgroundColor=new Color("#666"),mediumBar.size=new Size(stats.mediumIntensityPercent*1.4,10),mediumBar.cornerRadius=5,barStack.addSpacer(2);let highBar=barStack.addStack();highBar.backgroundColor=new Color("#FF5722"),highBar.size=new Size(stats.highIntensityPercent*1.4,10),highBar.cornerRadius=5}return list.url="scriptable:///run?scriptName=Strava%20Widget%20Summary&action=showSummary",list}async function main(){try{let CLIENT_ID=await Keychain.get("STRAVA_CLIENT_ID"),CLIENT_SECRET=await Keychain.get("STRAVA_CLIENT_SECRET"),REFRESH_TOKEN=await Keychain.get("STRAVA_REFRESH_TOKEN"),strava=new Strava(CLIENT_ID,CLIENT_SECRET,REFRESH_TOKEN,!0),activities=await strava.loadActivities(),zones=await strava.getAthleteZones(),athleteInfo=await strava.getAtheleteInfo(),{ftp,weight}=athleteInfo;if(!ftp||!weight)throw new Error("FTP or weight not set in athlete profile.");let widget=await createWidget(activities,ftp,weight,zones);config.runsInWidget?Script.setWidget(widget):await widget.presentMedium(),Script.complete()}catch(error){console.error("Error in main:",error);let errorWidget=new ListWidget,errorText=errorWidget.addText("Error loading Strava data");errorText.textColor=new Color("#FF0000"),config.runsInWidget?Script.setWidget(errorWidget):await errorWidget.presentMedium(),Script.complete()}}main();function formatTime(seconds){let hours=Math.floor(seconds/3600),minutes=Math.floor(seconds%3600/60);return hours>0?`${hours}h ${minutes}m`:`${minutes}m`}})();
